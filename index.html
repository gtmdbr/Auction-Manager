<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Auction</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: rgb(1,110,205);
            --accent: rgb(74,175,205);
            --accent1: rgb(250,166,50);
            --success: rgb(90,183,92);
            --danger: rgb(218,79,74);
            --neutral: rgb(112,116,117);
            --white: rgba(255, 255, 255, 0.9);
            --border: rgba(255, 255, 255, 0.2);
            --background: rgba(255, 255, 255, 0.6);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            min-height: 100vh;
            background: rgb(0,0,0);
            align-items: center;
            text-align: center;
            max-width: 100vw;
            color: #111827;
            font-weight: 400;
            padding-top: 1.5rem;
        }
        .gradient-wrap {
overflow: hidden;
width: 100%;
height:100vh;
z-index: -1;            
position: fixed;
}
.meshgradient>.color {
width: 100%;
height:100%;
position: fixed;
display: flex;
align-items: center;
transform: scale(3) rotate(0deg);
top:0;
bottom:0;
left:0;
right:0;
margin: auto;
background-repeat: no-repeat;
mix-blend-mode: overlay;
}

.c1 {
background: radial-gradient(#161179 25%, transparent 50%);
background-size: 60% 80%;
background-position: 0 0;
animation: c1 8s infinite linear;
}
.c2 {
background: radial-gradient(#410445 25%, transparent 50%);
background-size: 70% 80%;
background-position: 0 100%;
animation: c2 10s infinite linear;
}

.c3 {
background: radial-gradient(#BB563D 25%, transparent 50%);
background-size: 80% 80%;
background-position: 50% 0;
animation: c3 5s infinite linear;
}
.c4 {
background: radial-gradient(#A5158C 25%, transparent 50%);
background-size: 80% 80%;
background-position: 50% 100%;
animation: c4 6s infinite linear;
}

@keyframes c1 { 50%{ 
    background-size: 80% 80%;
    background-position: 50% 100%;
    transform: scale(3) rotate(-75deg);
  }
}

@keyframes c2 {
  50%{ 
    background-size: 80% 80%;
   background-position: 50% 0;
    transform: scale(3) rotate(90deg);
  }
}
@keyframes c3 {
  50%{ 
  background-size: 70% 80%;
   background-position: 0 100%;
   transform: scale(3) rotate(8deg);
  }
}

@keyframes c4 {
  50%{ 
   background-position: 0 0;
  animation: c1 10s infinite;
    transform: scale(3) rotate(-36deg);
  }
}

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(180, 180, 180, 0.2);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            padding: 0.4rem;
            text-align: center;
            justify-content: center;
            color: #ffffff;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .container {
            max-width: 80%;
            inset-inline: 2rem;
            align-items: center;
            padding: 2rem;
        }

        .card {
            background: rgba(200, 200, 200, 0.6);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            margin-block: 1.5rem;
            inset-inline: 10%;
            align-self: auto;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 2;
        }
        
        .mnu {
            position: fixed;
            top: 3rem; 
            right: 1rem;
            z-index: 30;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1rem;
            display: flex;
            padding: 2rem;
            box-shadow: var(--shadow);
            align-items: center;
            justify-content: center;
        }

        .mnu-neutral { background: #999999; }
        .mnu-neutral:hover { background: #4b5563; }

        .btn {
            width: auto;
            height: 42px;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            position: relative;
            align-items: center;
            align-self: safe center;
            color: #ffffff;
            margine-block: 1rem;
            gap: 1rem;
            padding: 1.5rem;
            text-transform: uppercase;
        }

        .btn.round {
            width: 48px;
            padding: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary { background: var(--primary); }
        .btn-primary:hover { outline: 1px var(--border); }
        .btn-accent { background: var(--accent); }
        .btn-accent:hover { outline: 1px var(--border); }
        .btn-accent1 { background: var(--accent1); }
        .btn-accent1:hover { outline: 1px var(--border); }
        .btn-success { background: var(--success); }
        .btn-success:hover { outline: 1px var(--border); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { outline: 1px var(--border); }
        .btn-neutral { background: var(--neutral); }
        .btn-neutral:hover { outline: 1px var(--border); }

        input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-weight: 400;
            align-items: center;
            text-align: center;
            width: 100%;
            background: var(--background);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            align-self: safe center;
            justify-content: center;
            z-index: 100;
            box-shadow: var(--shadow);
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.open {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--background);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            align-items: center;
            align-self: safe center;
            border-radius: 1px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .scrollable {
            max-height: 250px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0.5rem;
        }

        .grid-cols-auto {
            display: grid;
            grid-gap: 1.5rem;
            gap: 1.5rem;
            margin-block: 10px;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .flex-gap {
            display: inline-flex;
            flex-wrap: wrap;
        }

        .flex-gap > * {
            margin-inline: 0.5rem;
            margin-block: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .mt-3 {
            margin-block: 0.75rem;
        }

        .cycle-vis {
            background: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #8f8f8f;
            min-height: 2.5rem;
            display: block;
            white-space: normal;
            box-shadow: var(--shadow);
            overflow-x: auto;
            z-index: 5;
        }

        .cycle-vis .active {
            font-weight: 600;
            color: #1C1F8B;
        }

        .cycle-vis .banned {
            color: #f4c4c4;
        }

        .grid-container {
            display: grid;
            align-items: center;
            grid-template-columns: 1fr 1fr 1fr;
            grid-gap: 1.5rem;
            gap: 2rem;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(180, 180, 180, 0.4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            padding: 1rem;
            color: white;
            text-align: center;
            box-shadow: var(--shadow);
            border-top: 1px solid var(--border);
            z-index: 10;
        }
        .cls {
            position: fixed;
            top: -0.5rem; 
            right: -0.5rem;
            z-index: 30;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.2rem;
            align-items: center;
            box-shadow: var(--shadow);
            justify-content: center;
        }

        .cls-neutral { background: #dc2626; }
        .cls-neutral:hover { background: #ff2626; }
        .box {
            background: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            min-height: 2.5rem;
            display: block;
            white-space: normal;
            box-shadow: var(--shadow);
            overflow-x: auto;
            z-index: 5;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <div class="gradient-wrap meshgradient">
   <div class="color c1"></div>
   <div class="color c2"></div>
   <div class="color c3"></div>
   <div class="color c4"></div>
    </div>
    
    <header>
        <h1 id="eventName" class="text-2xl text-white py-2">Cricket Auction</h1>
    </header>

    <a id="menu">
        <button id="menuBtn" class="mnu mnu-neutral rounded-full"><i class="fa-regular fa-gear"></i></button>
    </a>

    <div class="container">
        <div class="card">
            <h2 class="text-xl font-semibold mb-3">Auction Control</h2>
            <div class="flex flex-row mb-3">
                <div class="basis-2/3">
                    <label class="block text-sm font-medium mb-1">Player Name</label>
                    <input id="playerName" class="box text-centre" type="text" placeholder="Enter player name">
                </div>
                <div class="basis-1/3">
                    <label class="block text-sm font-medium mb-1">Current Bid (₹)</label>
                    <input id="currentBid" class="box text-lg text-centre font-bold" type="number" value="20" min="20" readonly>
                </div>
            </div>
                <div class="flex">
                    <label class="block text-sm font-medium mb-1">Bidding Cycle</label>
                    <div id="cycleVisualization" class="cycle-vis text-centre"></div>
                </div>
            
                <div class="flex-gap mb-4">
                    <button id="placeBid" class="btn btn-primary">Bid</button>
                    <button id="skipBid" class="btn btn-accent">Skip</button>
                    <button id="outBid" class="btn btn-accent1">Out</button>
                    <button id="allocatePlayer" class="btn btn-success">Allocate</button>
                    <button id="cancelBid" class="btn btn-danger">Cancel</button>
                </div>
            <p id="bidError" class="text-red-500 mt-3 hidden"></p>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-3">Bid History</h2>
            <div id="bidHistory" class="scrollable"></div>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-3">Team Status</h2>
            <div id="teamStatus" class="grid-cols-auto"></div>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-3">Unsold Players</h2>
            <div id="unsoldPlayers" class="scrollable"></div>
        </div>

        <div class="card">
            <div class="flex-gap items-center" >
                <button id="exportTeam" class="btn btn-primary"><i class="fas fa-download"></i> Export Team</button>
                <button id="exportData" class="btn btn-primary"><i class="fas fa-download"></i> Export Data</button>
            </div>
        </div>
        <footer>
            <h2 class="text-sm text-white py-1.5">Developed by GTMDBR</h2>
        </footer>   
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-3">Settings</h2>
            <button id="closeSettings" class="cls cls-neutral"><i class="fas fa-times"style="color: #ffffff;"></i></button>
            <div class="flex flex-col gap-3">
                <button id="editEventName" class="btn btn-primary">Edit Event Name</button>
                <button id="editTeams" class="btn btn-primary">Edit Teams</button>
                <button id="editRules" class="btn btn-primary">Edit Rules</button>
                <button id="restoreDataBtn" class="btn btn-primary" title="Restore Auction Data"><i class="fas fa-undo"></i>  Restore Saved Data</button>
                <button id="resetData" class="btn btn-danger"><i class="fas fa-trash"></i>  Reset Data</button>
            </div>
        </div>
    </div>

    <div id="editEventNameModal" class="modal">
        <div class="modal-content">
            <button id="cancelEventName" class="cls cls-neutral"><i class="fas fa-times"style="color: #ffffff;"></i></button>
            <h2 class="text-xl font-semibold mb-3">Edit Event Name</h2>
            <label class="block text-sm font-medium mb-1">Event Name</label>
            <input id="eventNameInput" type="text" value="Cricket Auction">
            <div class="flex-gap mt-4">
                <buttonprudhvi@prudhvi-Lenovo-G50-80:~/Desktop$ dir
                <button id="saveEventName" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>

    <div id="editTeamsModal" class="modal">
        <div class="modal-content">
            <button id="cancelTeams" class="cls cls-neutral"><i class="fas fa-times"style="color: #ffffff;"></i></button>
            <h2 class="text-xl font-semibold mb-3">Edit Teams</h2>
            <div id="teamInputs"></div>
            <div class="flex-gap mt-4">
                <button id="saveTeams" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                
            </div>
        </div>
    </div>

    <div id="editRulesModal" class="modal">
        <div class="modal-content">
            <button id="cancelRules" class="cls cls-neutral"><i class="fas fa-times"style="color: #ffffff;"></i></button>
            <h2 class="text-xl font-semibold mb-3">Edit Rules</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Teams</label>
                    <input id="numTeams" type="number" value="5" min="1" max="10">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Budget (₹)</label>
                    <input id="maxBudget" type="number" value="4000" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Min Players</label>
                    <input id="minPlayers" type="number" value="11" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Min Bid (₹)</label>
                    <input id="minBid" type="number" value="20" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Increment 1-5 Bids (₹)</label>
                    <input id="increment1" type="number" value="20" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Increment 6-10 Bids (₹)</label>
                    <input id="increment2" type="number" value="30" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Increment 11+ Bids (₹)</label>
                    <input id="increment3" type="number" value="50" min="1">
                </div>
                <div>
                    <label class="inline-flex items-center">
                        <input id="dataProtection" type="checkbox" class="h-4 w-4 text-primary">
                        <span class="ml-2 text-sm">Save Data</span>
                    </label>
                </div>
            </div>
            <div class="flex-gap mt-4">
                <button id="saveRules" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                
            </div>
        </div>
    </div>

    <div id="cancelBidModal" class="modal">
        <div class="modal-content">
            <button id="closeCancelBid" class="cls cls-neutral"><i class="fas fa-times"style="color: #ffffff;"></i></button>
            <h2 class="text-xl font-semibold mb-3">Cancel Bid Options</h2>
            <p class="text-sm mb-4">Choose an action for the current player:</p>
            <div class="flex-gap">
                <button id="cancelLastStep" class="btn btn-primary">Cancel Last Step</button>
                <button id="cancelBiddingPlayer" class="btn btn-danger">Cancel Bidding Player</button>
                
            </div>
        </div>
    </div>

    <script>
        let state = {
            eventName: "Cricket Auction",
            teams: Array(5).fill().map((_, i) => ({
                name: `Team ${String.fromCharCode(65 + i)}`,
                budget: 4000,
                spent: 0,
                players: [],
                skips: {},
                banned: {}
            })),
            bidCount: 0,
            currentPlayer: '',
            currentBid: 20,
            currentTeamIndex: 0,
            lastBiddingTeamIndex: -1,
            lastBidOpenerTeamIndex: -1,
            continuousSkips: 0,
            playerOrder: -1,
            bidHistory: [],
            completedPlayers: [],
            allocatedPlayers: new Set(),
            rules: {
                numTeams: 5,
                maxBudget: 4000,
                minPlayers: 11,
                minBid: 20,
                increment1: 20,
                increment2: 30,
                increment3: 50,
                dataProtection: true
            }
        };

        const els = {
            eventName: document.getElementById('eventName'),
            playerName: document.getElementById('playerName'),
            currentBid: document.getElementById('currentBid'),
            cycle: document.getElementById('cycleVisualization'),
            placeBid: document.getElementById('placeBid'),
            skipBid: document.getElementById('skipBid'),
            allocate: document.getElementById('allocatePlayer'),
            cancelBid: document.getElementById('cancelBid'),
            outBid: document.getElementById('outBid'),
            exportTeam: document.getElementById('exportTeam'),
            exportData: document.getElementById('exportData'),
            bidError: document.getElementById('bidError'),
            bidHistory: document.getElementById('bidHistory'),
            teamStatus: document.getElementById('teamStatus'),
            unsoldPlayers: document.getElementById('unsoldPlayers'),
            menuBtn: document.getElementById('menuBtn'),
            settingsModal: document.getElementById('settingsModal'),
            editEventName: document.getElementById('editEventName'),
            editTeams: document.getElementById('editTeams'),
            editRules: document.getElementById('editRules'),
            resetData: document.getElementById('resetData'),
            closeSettings: document.getElementById('closeSettings'),
            eventNameModal: document.getElementById('editEventNameModal'),
            teamsModal: document.getElementById('editTeamsModal'),
            rulesModal: document.getElementById('editRulesModal'),
            eventNameInput: document.getElementById('eventNameInput'),
            saveEventName: document.getElementById('saveEventName'),
            cancelEventName: document.getElementById('cancelEventName'),
            teamInputs: document.getElementById('teamInputs'),
            saveTeams: document.getElementById('saveTeams'),
            cancelTeams: document.getElementById('cancelTeams'),
            numTeams: document.getElementById('numTeams'),
            maxBudget: document.getElementById('maxBudget'),
            minPlayers: document.getElementById('minPlayers'),
            minBid: document.getElementById('minBid'),
            increment1: document.getElementById('increment1'),
            increment2: document.getElementById('increment2'),
            increment3: document.getElementById('increment3'),
            dataProtection: document.getElementById('dataProtection'),
            saveRules: document.getElementById('saveRules'),
            cancelRules: document.getElementById('cancelRules'),
            cancelBidModal: document.getElementById('cancelBidModal'),
            cancelLastStep: document.getElementById('cancelLastStep'),
            cancelBiddingPlayer: document.getElementById('cancelBiddingPlayer'),
            closeCancelBid: document.getElementById('closeCancelBid'),
            restoreDataBtn: document.getElementById('restoreDataBtn')
        };

        function resetState() {
            state = {
                eventName: "Cricket Auction",
                teams: Array(5).fill().map((_, i) => ({
                    name: `Team ${String.fromCharCode(65 + i)}`,
                    budget: 4000,
                    spent: 0,
                    players: [],
                    skips: {},
                    banned: {}
                })),
                bidCount: 0,
                currentPlayer: '',
                currentBid: 20,
                currentTeamIndex: 0,
                lastBiddingTeamIndex: -1,
                lastBidOpenerTeamIndex: -1,
                continuousSkips: 0,
                playerOrder: -1,
                bidHistory: [],
                completedPlayers: [],
                allocatedPlayers: new Set(),
                rules: {
                    numTeams: 5,
                    maxBudget: 4000,
                    minPlayers: 11,
                    minBid: 20,
                    increment1: 20,
                    increment2: 30,
                    increment3: 50,
                    dataProtection: true
                }
            };
            try {
                localStorage.removeItem('auctionState');
            } catch (e) {
                console.warn('localStorage access denied:', e);
            }
            els.playerName.value = '';
            els.currentBid.value = state.currentBid;
            updateUI();
        }

        function loadState() {
            if (!state.rules.dataProtection) return;
            try {
                const saved = localStorage.getItem('auctionState');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(state, parsed);
                    state.allocatedPlayers = new Set(parsed.allocatedPlayers || []);
                    els.currentBid.value = state.currentBid;
                    els.playerName.value = state.currentPlayer || '';
                    els.eventName.textContent = state.eventName || "Cricket Auction";
                }
            } catch (e) {
                console.warn('Failed to load state:', e);
            }
            updateUI();
        }

        function saveState() {
            if (!state.rules.dataProtection) return;
            try {
                localStorage.setItem('auctionState', JSON.stringify({
                    ...state,
                    allocatedPlayers: [...state.allocatedPlayers]
                }));
            } catch (e) {
                console.warn('Failed to save state:', e);
            }
        }

        function getMaxBid(team) {
            return Math.max(0, team.budget - team.spent - Math.max(0, state.rules.minPlayers - team.players.length) * state.rules.minBid);
        }

        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showError(msg) {
            els.bidError.textContent = msg;
            els.bidError.classList.remove('hidden');
        }

        function clearError() {
            els.bidError.classList.add('hidden');
        }

        function formatPlayerLog(player, actions) {
            if (!actions.length) return '';
            const parts = actions.map((a, i) => {
                if (a.action === 'Bid') return `${i === 0 ? 'starts by ' : 'then '}bid ${state.teams[a.team].name.toLowerCase()} ${a.amount}`;
                if (a.action === 'Skipped') return `${i === 0 ? 'starts by ' : 'then '}skip ${state.teams[a.team].name.toLowerCase()}`;
                return '';
            }).filter(Boolean);
            return `${player}: ${parts.join(' ')}`.replace(/ then $/, '');
        }

        function updateUI() {
            console.log('Updating UI...');
            els.eventName.textContent = state.eventName || "Cricket Auction";
            els.teamStatus.innerHTML = state.teams.map(t => `
                <div class="bg-white bg-opacity-80 rounded-lg p-4">
                    <h3 class="text-base font-semibold">${t.name}</h3>
                    <p class="text-sm">Budget Left: ₹${t.budget - t.spent}</p>
                    <p class="text-sm">Max Bid: ₹${getMaxBid(t)}</p>
                    <p class="text-sm">Players: ${t.players.length}${t.players.length < state.rules.minPlayers ? ` <span class="text-red-500">(Need ${state.rules.minPlayers - t.players.length})</span>` : ''}</p>
                    <p class="text-sm">Spent: ₹${t.spent}</p>
                    <ul class="list-disc pl-4 text-sm mt-2">${t.players.map(p => `<li>${p.name} (₹${p.price})</li>`).join('')}</ul>
                    <p class="text-sm">Skips: ${state.currentPlayer ? (t.skips[state.currentPlayer] || 0) : 0}/3${t.banned[state.currentPlayer] ? ' <span class="text-red-500">(Banned)</span>' : ''}</p>
                </div>
            `).join('');

            const currentActions = state.currentPlayer ? state.bidHistory.filter(b => b.player === state.currentPlayer && ['Bid', 'Skipped'].includes(b.action)) : [];
            const currentLog = state.currentPlayer ? formatPlayerLog(state.currentPlayer, currentActions) : '';
            els.bidHistory.innerHTML = [
                ...state.completedPlayers.map(p => `<p class="text-sm">${p.log}</p>`),
                currentLog ? `<p class="text-sm">${currentLog}</p>` : ''
            ].join('');
            els.bidHistory.scrollTop = els.bidHistory.scrollHeight;

            els.unsoldPlayers.innerHTML = state.completedPlayers.filter(p => p.status === 'Unsold').length 
                ? state.completedPlayers.filter(p => p.status === 'Unsold').map(p => `<p class="text-sm">${p.player}</p>`).join('')
                : '<p class="text-sm">No unsold players yet.</p>';

            console.log('Teams:', state.teams);
            els.cycle.innerHTML = state.teams.length 
                ? state.teams.map((t, i) => {
                    let text = t.name;
                    if (state.currentPlayer && t.banned[state.currentPlayer]) text += ' (Banned)';
                    return `<span class="${i === state.currentTeamIndex ? 'active' : ''} ${state.currentPlayer && t.banned[state.currentPlayer] ? 'banned' : ''}">${text}</span>`;
                }).join(' → ')
                : 'No teams available';
            console.log('Cycle HTML:', els.cycle.innerHTML);
            els.currentBid.value = state.currentBid;
            saveState();

            requestAnimationFrame(() => {
                els.cycle.style.display = 'none';
                els.cycle.offsetHeight;
                els.cycle.style.display = 'block';
            });
        }

        function getMinIncrement() {
            return state.bidCount < 5 ? state.rules.increment1 : state.bidCount < 10 ? state.rules.increment2 : state.rules.increment3;
        }

        function nextTeam() {
            let startIndex = state.currentTeamIndex;
            do {
                state.currentTeamIndex = (state.currentTeamIndex + 1) % state.teams.length;
                if (state.currentTeamIndex === startIndex || !state.teams.length) break;
            } while (state.currentPlayer && state.teams[state.currentTeamIndex].banned[state.currentPlayer]);
            updateUI();
        }

        function setNextBidOpener() {
            state.lastBidOpenerTeamIndex = state.lastBidOpenerTeamIndex === -1 ? -1 : state.lastBidOpenerTeamIndex;
            state.currentTeamIndex = (state.lastBidOpenerTeamIndex + 1) % state.teams.length;
            if (state.currentPlayer && state.teams.length) {
                let startIndex = state.currentTeamIndex;
                while (state.teams[state.currentTeamIndex].banned[state.currentPlayer]) {
                    state.currentTeamIndex = (state.currentTeamIndex + 1) % state.teams.length;
                    if (state.currentTeamIndex === startIndex) break;
                }
            }
            updateUI();
        }

        function validatePlayer(player, isNew) {
            if (!player) {
                showError('Enter a player name!');
                return false;
            }
            if (state.allocatedPlayers.has(player.toLowerCase())) {
                showError(`${player} already allocated!`);
                return false;
            }
            if (isNew && state.currentPlayer && (state.bidCount > 0 || state.continuousSkips > 0)) {
                showError('Allocate, cancel, or mark unsold first!');
                return false;
            }
            return true;
        }

        els.placeBid.addEventListener('click', () => {
            const player = els.playerName.value.trim();
            const team = state.teams[state.currentTeamIndex];

            if (!validatePlayer(player, state.currentPlayer !== player)) return;

            if (state.currentPlayer !== player) {
                state.playerOrder++;
                state.currentPlayer = player;
                state.bidCount = 0;
                state.currentBid = state.rules.minBid;
                state.continuousSkips = 0;
                state.lastBiddingTeamIndex = -1;
                state.teams.forEach(t => {
                    t.skips[player] = t.skips[player] || 0;
                    t.banned[player] = t.banned[player] || false;
                });
                state.lastBidOpenerTeamIndex = state.currentTeamIndex;
            }

            if (team.banned[player]) {
                showError(`${team.name} is banned!`);
                return;
            }

            const newBid = state.bidCount === 0 ? state.rules.minBid : state.currentBid + getMinIncrement();
            const maxBid = getMaxBid(team);

            if (newBid > maxBid) {
                showError(`Bid ₹${newBid} exceeds ${team.name}'s max ₹${maxBid}!`);
                return;
            }
            if (newBid > team.budget - team.spent) {
                showError(`${team.name} can't afford ₹${newBid}!`);
                return;
            }

            state.bidCount++;
            state.currentBid = newBid;
            els.currentBid.value = newBid;
            state.continuousSkips = 0;
            state.lastBiddingTeamIndex = state.currentTeamIndex;
            state.bidHistory.push({ player, action: 'Bid', amount: newBid, team: state.currentTeamIndex });
            clearError();
            nextTeam();
        });

        els.skipBid.addEventListener('click', () => {
            const player = els.playerName.value.trim();
            const team = state.teams[state.currentTeamIndex];

            if (!validatePlayer(player, state.currentPlayer !== player)) return;

            if (state.currentPlayer !== player) {
                state.playerOrder++;
                state.currentPlayer = player;
                state.bidCount = 0;
                state.currentBid = state.rules.minBid;
                state.continuousSkips = 0;
                state.lastBiddingTeamIndex = -1;
                state.teams.forEach(t => {
                    t.skips[player] = t.skips[player] || 0;
                    t.banned[player] = t.banned[player] || false;
                });
                state.lastBidOpenerTeamIndex = state.currentTeamIndex;
            }

            team.skips[player]++;
            state.continuousSkips++;
            state.bidHistory.push({ player, action: 'Skipped', team: state.currentTeamIndex });

            if (team.skips[player] >= 3) {
                team.banned[player] = true;
                state.bidHistory.push({ player, action: 'Banned', team: state.currentTeamIndex });
            }

            if (state.bidCount === 0 && state.continuousSkips >= state.teams.length) {
                const actions = state.bidHistory.filter(b => b.player === player && ['Bid', 'Skipped'].includes(b.action));
                state.completedPlayers.push({ player, log: formatPlayerLog(player, actions), status: 'Unsold' });
                state.bidHistory = state.bidHistory.filter(b => b.player !== player);
                state.allocatedPlayers.add(player.toLowerCase());
                els.playerName.value = '';
                state.currentBid = state.rules.minBid;
                els.currentBid.value = state.currentBid;
                state.bidCount = 0;
                state.continuousSkips = 0;
                state.currentPlayer = '';
                state.lastBiddingTeamIndex = -1;
                state.playerOrder++;
                setNextBidOpener();
                clearError();
                updateUI();
                return;
            }

            clearError();
            nextTeam();
        });

        els.allocate.addEventListener('click', () => {
            const player = els.playerName.value.trim();

            if (!player || state.currentPlayer !== player) {
                showError('No active bid or invalid player!');
                return;
            }
            if (state.allocatedPlayers.has(player.toLowerCase())) {
                showError(`${player} already allocated!`);
                return;
            }
            if (state.bidCount < 1 || state.lastBiddingTeamIndex === -1) {
                showError('Need at least one bid to allocate!');
                return;
            }

            const team = state.teams[state.lastBiddingTeamIndex];
            const maxBid = getMaxBid(team);

            if (state.currentBid > maxBid) {
                showError(`Bid ₹${state.currentBid} exceeds ${team.name}'s max ₹${maxBid}!`);
                return;
            }
            if (state.currentBid > team.budget - team.spent) {
                showError(`${team.name} can't afford ₹${state.currentBid}!`);
                return;
            }

            team.players.push({ name: player, price: state.currentBid });
            team.spent += state.currentBid;
            state.allocatedPlayers.add(player.toLowerCase());
            const actions = state.bidHistory.filter(b => b.player === player && ['Bid', 'Skipped'].includes(b.action));
            state.completedPlayers.push({ 
                player, 
                log: `${formatPlayerLog(player, actions)} - allocated to ${team.name} for ₹${state.currentBid}`,
                status: 'Allocated'
            });
            state.bidHistory = state.bidHistory.filter(b => b.player !== player);

            els.playerName.value = '';
            state.currentBid = state.rules.minBid;
            els.currentBid.value = state.currentBid;
            state.bidCount = 0;
            state.continuousSkips = 0;
            state.currentPlayer = '';
            state.lastBiddingTeamIndex = -1;
            state.playerOrder++;
            setNextBidOpener();
            clearError();
            updateUI();
        });

        els.cancelBid.addEventListener('click', () => {
            const player = els.playerName.value.trim();

            if (!player || state.currentPlayer !== player || !state.bidHistory.some(b => b.player === player && ['Bid', 'Skipped'].includes(b.action))) {
                showError('No actions to cancel!');
                return;
            }

            console.log('Opening cancel bid modal');
            els.cancelBidModal.classList.add('open');
            clearError();
        });

        els.cancelLastStep.addEventListener('click', () => {
            const player = state.currentPlayer;

            if (!player || !state.bidHistory.length) {
                showError('No actions to cancel!');
                els.cancelBidModal.classList.remove('open');
                return;
            }

            const lastActionIndex = state.bidHistory.slice().reverse().findIndex(b => b.player === player && ['Bid', 'Skipped'].includes(b.action));
            if (lastActionIndex === -1) {
                showError('No action found to cancel!');
                els.cancelBidModal.classList.remove('open');
                return;
            }

            const lastAction = state.bidHistory[state.bidHistory.length - 1 - lastActionIndex];
            state.bidHistory.splice(state.bidHistory.length - 1 - lastActionIndex, 1);

            if (lastAction.action === 'Bid') {
                state.bidCount = Math.max(0, state.bidCount - 1);
                if (state.bidCount === 0) {
                    state.currentBid = state.rules.minBid;
                    state.lastBiddingTeamIndex = -1;
                    state.currentTeamIndex = state.lastBidOpenerTeamIndex;
                } else {
                    const prevBid = state.bidHistory.slice().reverse().find(b => b.player === player && b.action === 'Bid');
                    state.currentBid = prevBid ? prevBid.amount : state.rules.minBid;
                    state.lastBiddingTeamIndex = prevBid ? prevBid.team : -1;
                    state.currentTeamIndex = prevBid ? prevBid.team : state.lastBidOpenerTeamIndex;
                }
            } else if (lastAction.action === 'Skipped') {
                const team = state.teams[lastAction.team];
                team.skips[player] = Math.max(0, (team.skips[player] || 0) - 1);
                if (team.skips[player] < 3) team.banned[player] = false;
                state.continuousSkips = Math.max(0, state.continuousSkips - 1);
                state.currentTeamIndex = lastAction.team;
            }

            els.currentBid.value = state.currentBid;
            if (state.currentPlayer && state.teams[state.currentTeamIndex]?.banned[state.currentPlayer]) {
                nextTeam();
            }

            clearError();
            els.cancelBidModal.classList.remove('open');
            updateUI();
        });

        els.cancelBiddingPlayer.addEventListener('click', () => {
            const player = state.currentPlayer;

            if (!player) {
                showError('No player to cancel!');
                els.cancelBidModal.classList.remove('open');
                return;
            }

            state.bidHistory = state.bidHistory.filter(b => b.player !== player);
            state.teams.forEach(t => {
                t.skips[player] = 0;
                t.banned[player] = false;
            });
            state.bidCount = 0;
            state.currentBid = state.rules.minBid;
            els.currentBid.value = state.currentBid;
            state.currentPlayer = '';
            state.lastBiddingTeamIndex = -1;
            state.continuousSkips = 0;
            state.currentTeamIndex = state.lastBidOpenerTeamIndex;
            els.playerName.value = '';

            clearError();
            els.cancelBidModal.classList.remove('open');
            updateUI();
        });

        els.closeCancelBid.addEventListener('click', () => {
            console.log('Close cancel bid modal');
            els.cancelBidModal.classList.remove('open');
        });
        
        els.outBid.addEventListener('click', () => {
    const player = els.playerName.value.trim();
    const team = state.teams[state.currentTeamIndex];

    if (!validatePlayer(player, state.currentPlayer !== player)) return;

    if (state.currentPlayer !== player) {
        state.playerOrder++;
        state.currentPlayer = player;
        state.bidCount = 0;
        state.currentBid = state.rules.minBid;
        state.continuousSkips = 0;
        state.lastBiddingTeamIndex = -1;
        state.teams.forEach(t => {
            t.skips[player] = t.skips[player] || 0;
            t.banned[player] = t.banned[player] || false;
        });
        state.lastBidOpenerTeamIndex = state.currentTeamIndex;
    }

    if (team.banned[player]) {
        showError(`${team.name} is already banned!`);
        return;
    }

    team.banned[player] = true;
    state.bidHistory.push({ player, action: 'Banned', team: state.currentTeamIndex });
    clearError();
    nextTeam();
});

        els.exportTeam.addEventListener('click', () => {
            const unsold = state.completedPlayers.filter(p => p.status === 'Unsold').map(p => p.player);
            const html = `
                <html>
                <head>
                    <title>${escapeHTML(state.eventName)} - Team</title>
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 2rem; color: #111827; }
                        h1 { text-align: center; font-size: 1.75rem; }
                        h2 { font-size: 1.25rem; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
                        th, td { border: 1px solid #e5e7eb; padding: 0.75rem; }
                        th { background: #f9fafb; }
                        .credit { text-align: center; color: #6b7280; }
                        .none { color: #6b7280; }
                    </style>
                </head>
                <body>
                    <h1>${escapeHTML(state.eventName)}</h1>
                    ${state.teams.map(t => `
                        <h2>${escapeHTML(t.name)}</h2>
                        <table>
                            <tr><th>Budget</th><td>₹${t.budget}</td></tr>
                            <tr><th>Spent</th><td>₹${t.spent}</td></tr>
                            <tr><th>Remaining</th><td>₹${t.budget - t.spent}</td></tr>
                            <tr><th>Max Bid</th><td>₹${getMaxBid(t)}</td></tr>
                            <tr><th>Players</th><td>${t.players.length}</td></tr>
                            <tr><th>Roster</th><td>${t.players.length ? t.players.map(p => `${escapeHTML(p.name)} (₹${p.price})`).join(', ') : '<span class="none">None</span>'}</td></tr>
                        </table>
                    `).join('')}
                    <h2>Unsold Players</h2>
                    <table>
                        <tr><th>Player</th></tr>
                        ${unsold.length ? unsold.map(p => `<tr><td>${escapeHTML(p)}</td></tr>`).join('') : '<tr><td><span class="none">None</span></td></tr>'}
                    </table>
                    <div class="credit">Developed by GTMDBR</div>
                </body>
                </html>
            `;
            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                win.print();
            }
        });

        els.exportData.addEventListener('click', () => {
            const unsold = state.completedPlayers.filter(p => p.status === 'Unsold').map(p => p.player);
            const html = `
                <html>
                <head>
                    <title>${escapeHTML(state.eventName)} - Data</title>
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 2rem; color: #111827; }
                        h1 { text-align: center; font-size: 1.75rem; }
                        h2 { font-size: 1.25rem; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
                        th, td { border: 1px solid #e5e7eb; padding: 0.75rem; }
                        th { background: #f9fafb; }
                        .credit { text-align: center; color: #6b7280; }
                        .none { color: #6b7280; }
                    </style>
                </head>
                <body>
                    <h1>${escapeHTML(state.eventName)}</h1>
                    ${state.teams.map(t => `
                        <h2>${escapeHTML(t.name)}</h2>
                        <table>
                            <tr><th>Budget</th><td>₹${t.budget}</td></tr>
                            <tr><th>Spent</th><td>₹${t.spent}</td></tr>
                            <tr><th>Remaining</th><td>₹${t.budget - t.spent}</td></tr>
                            <tr><th>Max Bid</th><td>₹${getMaxBid(t)}</td></tr>
                            <tr><th>Players</th><td>${t.players.length}</td></tr>
                            <tr><th>Roster</th><td>${t.players.length ? t.players.map(p => `${escapeHTML(p.name)} (₹${p.price})`).join(', ') : '<span class="none">None</span>'}</td></tr>
                        </table>
                    `).join('')}
                    <h2>Unsold Players</h2>
                    <table>
                        <tr><th>Player</th></tr>
                        ${unsold.length ? unsold.map(p => `<tr><td>${escapeHTML(p)}</td></tr>`).join('') : '<tr><td><span class="none">None</span></td></tr>'}
                    </table>
                    <h2>Bid Log</h2>
                    <table>
                        <tr><th>Player</th><th>Log</th></tr>
                        ${state.completedPlayers.length ? state.completedPlayers.map(p => `
                            <tr>
                                <td>${escapeHTML(p.player)}</td>
                                <td>${escapeHTML(p.log)}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="2"><span class="none">No logs</span></td></tr>'}
                        ${state.currentPlayer ? `
                            <tr>
                                <td>${escapeHTML(state.currentPlayer)}</td>
                                <td>${escapeHTML(formatPlayerLog(state.currentPlayer, state.bidHistory.filter(b => b.player === state.currentPlayer && ['Bid', 'Skipped'].includes(b.action))))}</td>
                            </tr>
                        ` : ''}
                    </table>
                    <div class="credit">Developed by GTMDBR</div>
                </body>
                </html>
            `;
            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                win.print();
            }
        });

        els.menuBtn.addEventListener('click', () => {
            console.log('Menu button clicked');
            if (els.settingsModal) {
                els.settingsModal.classList.add('open');
            } else {
                console.error('Settings modal not found');
            }
        });

        els.closeSettings.addEventListener('click', () => {
            console.log('Close settings clicked');
            els.settingsModal.classList.remove('open');
        });

        els.editEventName.addEventListener('click', () => {
            console.log('Edit event name clicked');
            els.settingsModal.classList.remove('open');
            els.eventNameModal.classList.add('open');
            els.eventNameInput.value = state.eventName;
        });

        els.saveEventName.addEventListener('click', () => {
            console.log('Save event name clicked');
            const name = els.eventNameInput.value.trim();
            if (!name) {
                alert('Event name cannot be empty!');
                return;
            }
            state.eventName = name;
            updateUI();
            els.eventNameModal.classList.remove('open');
        });

        els.cancelEventName.addEventListener('click', () => {
            console.log('Cancel event name clicked');
            els.eventNameModal.classList.remove('open');
        });

        els.editTeams.addEventListener('click', () => {
            console.log('Edit teams clicked');
            els.settingsModal.classList.remove('open');
            els.teamsModal.classList.add('open');
            els.teamInputs.innerHTML = state.teams.map((t, i) => `
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Team ${i + 1}</label>
                    <input type="text" value="${t.name}" class="team-name" data-index="${i}">
                </div>
            `).join('');
        });

        els.saveTeams.addEventListener('click', () => {
            console.log('Save teams clicked');
            const inputs = document.querySelectorAll('.team-name');
            const names = [...inputs].map(i => i.value.trim().toLowerCase());
            if (names.some(n => !n) || new Set(names).size !== names.length) {
                alert('Team names must be unique and non-empty!');
                return;
            }
            inputs.forEach((i, idx) => state.teams[idx].name = i.value.trim());
            els.teamsModal.classList.remove('open');
            updateUI();
        });

        els.cancelTeams.addEventListener('click', () => {
            console.log('Cancel teams clicked');
            els.teamsModal.classList.remove('open');
        });

        els.editRules.addEventListener('click', () => {
            console.log('Edit rules clicked');
            els.settingsModal.classList.remove('open');
            els.rulesModal.classList.add('open');
            els.numTeams.value = state.rules.numTeams;
            els.maxBudget.value = state.rules.maxBudget;
            els.minPlayers.value = state.rules.minPlayers;
            els.minBid.value = state.rules.minBid;
            els.increment1.value = state.rules.increment1;
            els.increment2.value = state.rules.increment2;
            els.increment3.value = state.rules.increment3;
            els.dataProtection.checked = state.rules.dataProtection;
        });

        els.saveRules.addEventListener('click', () => {
            console.log('Save rules clicked');
            const rules = {
                numTeams: +els.numTeams.value,
                maxBudget: +els.maxBudget.value,
                minPlayers: +els.minPlayers.value,
                minBid: +els.minBid.value,
                increment1: +els.increment1.value,
                increment2: +els.increment2.value,
                increment3: +els.increment3.value,
                dataProtection: els.dataProtection.checked
            };

            if (Object.values(rules).slice(0, -1).some(v => v < 1) || rules.numTeams > 10) {
                alert('Values must be positive, teams 1–10!');
                return;
            }

            if (rules.numTeams > state.teams.length) {
                for (let i = state.teams.length; i < rules.numTeams; i++) {
                    state.teams.push({
                        name: `Team ${String.fromCharCode(65 + i)}`,
                        budget: rules.maxBudget,
                        spent: 0,
                        players: [],
                        skips: {},
                        banned: {}
                    });
                }
            } else if (rules.numTeams < state.teams.length) {
                state.teams = state.teams.slice(0, rules.numTeams);
                if (state.currentTeamIndex >= rules.numTeams) state.currentTeamIndex = 0;
                if (state.lastBiddingTeamIndex >= rules.numTeams) state.lastBiddingTeamIndex = -1;
                if (state.lastBidOpenerTeamIndex >= rules.numTeams) state.lastBidOpenerTeamIndex = -1;
            }

            state.teams.forEach(t => {
                t.budget = rules.maxBudget;
                if (t.spent > t.budget) alert(`Warning: ${t.name}'s spent exceeds new budget!`);
            });
            state.rules = rules;
            state.currentBid = rules.minBid;
            els.currentBid.value = rules.minBid;
            els.rulesModal.classList.remove('open');
            setNextBidOpener();
            updateUI();
            if (!rules.dataProtection) {
                try {
                    localStorage.removeItem('auctionState');
                } catch (e) {
                    console.warn('localStorage access denied:', e);
                }
            }
        });

        els.cancelRules.addEventListener('click', () => {
            console.log('Cancel rules clicked');
            els.rulesModal.classList.remove('open');
        });

        els.resetData.addEventListener('click', () => {
            console.log('Reset data clicked');
            if (confirm('Are you sure you want to reset all auction data? This cannot be undone.')) {
                resetState();
                els.settingsModal.classList.remove('open');
            }
        });

        // Restore Data Button Event Listener
        els.restoreDataBtn.addEventListener('click', () => {
            console.log('Restore data button clicked');
            if (!state.rules.dataProtection) {
                alert('Data protection is disabled. Enable it in Settings > Edit Rules to restore data.');
                return;
            }
            try {
                const saved = localStorage.getItem('auctionState');
                if (!saved) {
                    alert('No saved data found in local storage.');
                    return;
                }
                loadState();
                alert('Auction data restored successfully!');
            } catch (e) {
                console.warn('Failed to restore data:', e);
                alert('Failed to restore data. Please try again.');
            }
        });

        window.addEventListener('click', e => {
            if ([els.settingsModal, els.eventNameModal, els.teamsModal, els.rulesModal, els.cancelBidModal].includes(e.target)) {
                console.log('Modal background clicked:', e.target.id);
                e.target.classList.remove('open');
            }
        });

        console.log('Initializing...');
        loadState();
    </script>
</body>
</html>
